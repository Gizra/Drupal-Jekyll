<?php
/**
 * @file
 * Code for the Dekyll Github.
 */

use Github\Client;
use Github\HttpClient\CachedHttpClient;

use GitWrapper\GitWrapper;
use GitWrapper\GitWorkingCopy;
use GitWrapper\GitException;

use Symfony\Component\Yaml\Parser;
use Symfony\Component\Yaml\Dumper;

/**
 * Implements hook_menu().
 */
function dekyll_github_menu() {
  $items = array();

  $items['create-repository'] = array(
    'title' => 'Create Repository on Github',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dekyll_github_create_repository_github_form'),
    // @todo: Add access to github.
    'access callback' => 'user_is_logged_in',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Page callback; Create a new repository in Github.
 */
function dekyll_github_create_repository_github_form() {
  $params = array(
    '@github-account' => '',
  );

  $form['name'] = array(
    '#type' => 'textfield',
    '#title' => t('Repository name'),
    '#description' => t('The name of the repository that should be created under account @github-account in Github.', $params),
    '#required' => TRUE,
    // @todo: Add validate.
  );

  $form['actions'] = array('#type' => 'actions');
  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Create'),
  );

  return $form;
}


/**
 * Submit handler; Add "Create Repository" queue item.
 */
function dekyll_github_create_repository_github_form_submit($form, &$form_state) {
  global $user;
  dekyll_github_create_repository_github($user->uid, $form_state['values']['name']);
  drupal_set_message('Repository created.');
}

/**
 * Fork Gizra/jekyll-bootstrap repository.
 *
 * @param $uid
 */
function dekyll_github_create_repository_github($uid, $repo_name = 'jekyll-bootstrap') {
  $account = user_load($uid);
  if (!$token = dekyll_github_get_user_token($account)) {
    // No access token.
    return;
  }

  $client = new Github\Client(
    new Github\HttpClient\CachedHttpClient(array('cache_dir' => 'temporary://github-api-cache'))
  );

  $client->authenticate($token, NULL, Github\Client::AUTH_HTTP_TOKEN);

  $github_account = $client->api('current_user')->show();
  $github_username = $github_account['login'];

  try {
    $client->api('repo')->show($github_username, 'jekyll-bootstrap');
    // Repository already exists.
    return;
  }
  catch (Exception $e) {
  }

  try {
    $client->api('repo')->forks()->create('Gizra', 'jekyll-bootstrap');
    if ($repo_name != 'jekyll-bootstrap') {
      $client->api('repo')->update($github_username, 'jekyll-bootstrap', array('name' => $repo_name));
    }
  }
  catch (Exception $e) {
    // There was an error while forking.
    return;
  }

  $full_repo_name = $github_username . '/' . $repo_name;

  // Create a repository and branch nodes.
  $repo_node = (object)array(
    'type' => 'repository',
    'uid' => $account->uid,
    'title' => $repo_name,
  );

  node_object_prepare($repo_node);
  $wrapper = entity_metadata_wrapper('node', $repo_node);
  $wrapper->{OG_GROUP_FIELD}->set(TRUE);
  $wrapper->{OG_GROUP_FIELD}->set(TRUE);
  $wrapper->field_repo_url->set('https://github.com/' . $full_repo_name);
  $wrapper->field_repo_credentials->set('git@github.com:' . $full_repo_name);
  $wrapper->field_repo_canonical->set(FALSE);
  $wrapper->save();

  $branch_node = (object)array(
    'type' => 'branch',
    'uid' => $account->uid,
    'title' => 'gh-pages',
  );

  node_object_prepare($branch_node);
  $wrapper = entity_metadata_wrapper('node', $branch_node);
  $wrapper->{OG_AUDIENCE_FIELD}->set($repo_node);
  $wrapper->field_jekyll_base_path->set('config');
  $wrapper->save();
}


/**
 * Get Github access token.
 *
 * @param null $account
 * @return mixed
 */
function dekyll_github_get_user_token($account = NULL) {
  if (!$account) {
    global $user;
    $account = clone $user;
  }

  if (!$result = db_query("SELECT access_token FROM {github_connect_users} WHERE uid = :uid", array(':uid' => $account->uid))->fetchCol()) {
    return;
  }
  return str_replace(array('access_token=', '&token_type=bearer'), '', $result[0]);
}

/**
 * Implements hook_dekyll_repository_clone().
 *
 * If a fork of Gizra/jekyll-bootstrap, configure the _config.yml
 */
function dekyll_github_dekyll_repository_clone($node, GitWrapper\GitWorkingCopy $git) {
  if (!$token = dekyll_github_get_user_token()) {
    // No access token.
    return;
  }
  $wrapper = entity_metadata_wrapper('node', $node);
  if (!strpos($wrapper->field_repo_url->value(), 'https://github.com/') === 0) {
    // Not a Github repo.
    return;
  }

  $client = new Github\Client(
    new Github\HttpClient\CachedHttpClient(array('cache_dir' => 'temporary://github-api-cache'))
  );

  $client->authenticate($token, NULL, Github\Client::AUTH_HTTP_TOKEN);

  $github_account = $client->api('current_user')->show();
  $github_username = $github_account['login'];

  $repository_name = $wrapper->{OG_AUDIENCE_FIELD}->label();

  try {
    $repository = $client->api('repo')->show($github_username, $repository_name);
    return;
  }
  catch (Exception $e) {
    // There was an error.
    return;
  }

  // Not a fork.

  $path = dekyll_repository_get_repo_path($node);

  $file_path = $path . '/_config.yml';
  $contents = file_get_contents($file_path);

  $yaml = new Parser();
  $yaml->parse($contents);

  $production_url = "http://$github_username.github.io/$repository_name";
  $yaml['production_url'] = $production_url;

  $dumper = new Dumper();
  file_put_contents($file_path, $dumper->dump($yaml, 10));

  // Push to git.
  try {
    $git
      ->commit($file_path, array('m' => 'Configured _config.yml to point to ' . $production_url))
      ->push();
  }
  catch(GitException $e) {
    // File didn't change, we can return;
    return;
  }

}